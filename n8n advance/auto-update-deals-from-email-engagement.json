{
  "name": "auto-update-deals-from-email-engagement",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "email-engagement-events"
      },
      "id": "d1",
      "name": "Engagement Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "\nconst e = $json.body||{};\n// Map events to stage + probability deltas\nlet stage = 'CONTACTED', prob = 0.2;\nif (e.event==='open') { stage='CONTACTED'; prob=0.25; }\nif (e.event==='click') { stage='ENGAGED'; prob=0.4; }\nif (e.event==='reply') { stage='QUALIFIED_TO_BUY'; prob=0.7; }\nreturn [{ json: { email: e.email, event: e.event, stage, probability: prob } }];\n"
      },
      "id": "d2",
      "name": "Map Event \u2192 Stage/Prob",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        330,
        300
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "resource": "contact",
        "additionalFields": {
          "email": "={{$json.email}}"
        }
      },
      "id": "d3",
      "name": "Find Contact (HubSpot)",
      "type": "n8n-nodes-base.hubspot",
      "typeVersion": 1,
      "position": [
        560,
        300
      ],
      "credentials": {
        "hubspotApi": {
          "id": "hubspot_api_cred",
          "name": "HubSpot API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "\nconst contact = $json;\nconst dealId = contact.associations?.deals?.results?.[0]?.id || 0;\nreturn [{ json: { dealId, stage: $prevNode['Map Event \u2192 Stage/Prob'].json.stage, probability: $prevNode['Map Event \u2192 Stage/Prob'].json.probability, event: $prevNode['Map Event \u2192 Stage/Prob'].json.event } }];\n"
      },
      "id": "d4",
      "name": "Select Deal",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        790,
        300
      ]
    },
    {
      "parameters": {
        "resource": "deal",
        "operation": "update",
        "dealId": "={{$json.dealId}}",
        "updateFields": {
          "propertiesUi": {
            "propertyValues": [
              {
                "property": "dealstage",
                "value": "={{$json.stage}}"
              },
              {
                "property": "hs_deal_stage_probability",
                "value": "={{$json.probability}}"
              }
            ]
          }
        }
      },
      "id": "d5",
      "name": "Update Deal Stage",
      "type": "n8n-nodes-base.hubspot",
      "typeVersion": 1,
      "position": [
        1020,
        300
      ],
      "credentials": {
        "hubspotApi": {
          "id": "hubspot_api_cred",
          "name": "HubSpot API"
        }
      }
    },
    {
      "parameters": {
        "channel": "#pipeline-updates",
        "text": "Deal {{$json.dealId}} \u2192 *{{$prevNode['Map Event \u2192 Stage/Prob'].json.stage}}* via *{{$prevNode['Map Event \u2192 Stage/Prob'].json.event}}* (p={{$prevNode['Map Event \u2192 Stage/Prob'].json.probability}})."
      },
      "id": "d6",
      "name": "Slack Notify",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [
        1240,
        300
      ]
    },
    {
      "parameters": {
        "resource": "task",
        "operation": "create",
        "additionalFields": {
          "propertiesUi": {
            "propertyValues": [
              {
                "property": "hs_task_subject",
                "value": "={{'Follow-up after '+$prevNode['Map Event \u2192 Stage/Prob'].json.event}}"
              },
              {
                "property": "hs_task_priority",
                "value": "HIGH"
              },
              {
                "property": "hs_task_status",
                "value": "WAITING"
              },
              {
                "property": "hs_timestamp",
                "value": "={{$now}}"
              },
              {
                "property": "hs_task_body",
                "value": "={{'Review engagement and schedule call if needed.'}}"
              }
            ]
          }
        }
      },
      "id": "d7",
      "name": "Create Follow-up Task",
      "type": "n8n-nodes-base.hubspot",
      "typeVersion": 1,
      "position": [
        1460,
        300
      ],
      "credentials": {
        "hubspotApi": {
          "id": "hubspot_api_cred",
          "name": "HubSpot API"
        }
      }
    }
  ],
  "connections": {
    "Engagement Webhook": {
      "main": [
        [
          {
            "node": "Map Event \u2192 Stage/Prob",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Map Event \u2192 Stage/Prob": {
      "main": [
        [
          {
            "node": "Find Contact (HubSpot)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Contact (HubSpot)": {
      "main": [
        [
          {
            "node": "Select Deal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Deal": {
      "main": [
        [
          {
            "node": "Update Deal Stage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Deal Stage": {
      "main": [
        [
          {
            "node": "Slack Notify",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create Follow-up Task",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false
}